<!-- A start page for my new tabs and blocked pages -->
<html>
  <head>
    <meta charset="utf-8">
    <!-- NOTE: This is needed to keep your decryption password secure,
    and so you should only use browsers that support it -
    https://caniuse.com/#feat=referrer-policy . Otherwise, following
    links will send a referrer header which contains your password
    query parameter, to third parties. -->
    <meta name="referrer" content="no-referrer">
    <title>New Tab</title>
    <style>
      body {
        background-size: contain;
        margin: 0;
      }

      #agenda-frames {
        width: 30em;
        height: 100%;
        float: right;
      }

      #todoist-frame {
        width: 100%;
        height: 62%;
        border-width: 0;
      }

      #calendar-frame {
        width: 100%;
        height: 38%;
        border-width: 0;
      }

      .reminder {
        font-size: 200%;
        position: absolute;
        bottom: 0;
      }

      .reminder a {
        color: white;
      }

      #focus, #work-focus, #priorities, .reminder, #blocked, #unblock, #unblock-reminder, #unblock-confirm {
        display: none;
        background: rgba(0, 0, 0, 0.5);
        opacity: 0.9;
        color: white;
        margin: 32px;
        padding: 32px;
        border-radius: 32px;
      }

      #priorities {
        position: absolute;
        top: 128px;
        font-family: sans-serif;
      }

      #priorities h1 {
        font-size: 150%;
      }

      #priorities ul {
        font-size: 125%;
      }

      #focus {
        position: absolute;
        font-size: 200%;
        font-family: serif;
      }

      #blocked, #unblock, #unblock-reminder, #unblock-confirm {
        font-size: 200%;
        position: absolute;
        top: 124px;
        left: 0;
        opacity: 1 !important;
        background: black;
        z-index: 10;
      }

      #unblock-confirm {
        top: 280px !important;
      }

      #unblock input {
        filter: invert(100%);
        font-size: 120%;
      }

      #unblock-time {
        width: 2em;
      }

      form {
        margin-block-end: 0
      }

      a, a:visited {
        color: #0bf;
      }
    </style>

  </head>
  <body>
    <!-- Used by my site blocking extension https://github.com/mgsloan/unblock-with-intention -->
    <div id="blocked"></div>
    <div id="unblock">
      <div>
        Unblock intention?
        <input id="unblock-intention" type="text"/>
      </div>
      <div>
        For how long?
        <input id="unblock-time" type="number" value="5"/>
        minutes
      </div>
    </div>
    <div id="unblock-reminder">
      <b>Reminder (</b>
      <span id="unblock-reminder-counter"></span>
      <b>): </b>
      <span id="unblock-reminder-text"></span>
    </div>
    <div id="unblock-confirm">
      <b>Intention: </b>
      <span id="confirm-intention"></span>
      <br/>
      <span>Is this intention <b>legitimate</b>?</span>
    </div>

    <script>
      var urlParams = new URLSearchParams(window.location.search);
      var hasBlocked = urlParams.has('blocked');
      var hasPersonal = urlParams.has('personal');

      // Show site unblocking stuff
      if (hasBlocked) {
        document.title = 'Blocked site';
        const blockedUrl = urlParams.get('blocked');
        const blockedDiv = document.getElementById('blocked');
        const blockedLink = document.createElement('a');
        blockedLink.href = blockedUrl;
        blockedLink.textContent = blockedUrl;
        blockedDiv.style.display = 'inline-block';
        blockedDiv.textContent = 'Blocked ';
        blockedDiv.appendChild(blockedLink);
        document.onkeyup = ev => {
          if (ev.key === 'u' && blockedDiv.style.display === 'inline-block') {
            document.onkeyup = null;
            blockedDiv.style.display = 'none';
            const unblockDiv = document.getElementById('unblock');
            unblockDiv.style.display = 'inline-block';
            const intentionInput = document.getElementById('unblock-intention');
            intentionInput.focus();
          }
        };
      }

      const picsumUrl = 'https://picsum.photos/1920/1080?random';
      async function getApodUrl() {
        const today = new Date();
        today.setHours(0,0,0,0);
        // May as well be friendly to nasa's servers and try to only query apod once a day :)
        const apodDayRaw = localStorage.getItem('apodDayRaw');
        if (apodDayRaw) {
          const apodDay = new Date(apodDayRaw);
          apodDay.setHours(0,0,0,0);
          if (apodDay.getTime() == today.getTime()) {
            console.log('Date match - attempting to use cached apod url');
            const apodUrl = localStorage.getItem('apodUrl');
            if (apodUrl) {
              console.log('Successfully used cached apod url');
              return apodUrl;
            }
          }
        }
        const response = await fetch('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY');
        const json = await response.json();
        const url = json.hdurl;
        localStorage.setItem('apodDayRaw', today.toString());
        localStorage.setItem('apodUrl', url);
        return url;
      }
      async function updateBackground() {
        // let url = Math.random() > 0.5 ? await getApodUrl() : picsumUrl;
        let url = await getApodUrl();
        if (url === undefined || url === 'undefined') {
          url = picsumUrl;
        }
        document.body.style.backgroundImage = 'url("' + url + '")';
      }
      updateBackground();
    </script>
  </body>
</html>
